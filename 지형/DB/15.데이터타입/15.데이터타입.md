# 15. 데이터 타입

# 15.1 문자열 (CHAR와 VCHAR)

문자열 칼럼을 사용할 떄 어떠한 타입을 사용해야 할까?

`CHAR` , `VARCHAR` 타입의 저장공간과 비교 방식의 관점에서 


## 15.1.1 저장공간

`CHAR`와 `VARCHAR`의 공통점은 문자열을 저장할 수 있는 데이터 타입이다.

가장 큰 차이는 `고정 길이`(CHAR), `가변 길이`(VARCHAR)이다.

<br>

### 고정 길이 (CHAR 타입)

실제 입력되는 칼럼값의 길이에 따라 사용하는 저장 공간의 크기가 변하지 않는다.

실제 저장된 값의 유효 크기가 얼마인지 별도로 저장할 필요가 없으므로 추가로 공간이 필요하지 않다.

<br>

<p align="center"><img src = images/01.png width=600></p>

<br>

### 가변 길이 (VARCHAR 타입)

최대로 저장할 수 있는 값의 길이는 제한돼 있지만, 그 이하 크기의 값이 저장되면 그만큼 저장 공간이 줄어든다.

하지만 저장된 값의 유효 크기가 얼마인지를 별도로 저장해야한다.

그래서 1 ~ 2 바이트의 저장 공간이 추가로 더 필요하다.

<br>

<p align="center"><img src = images/02.png width=600></p>

<br>

### 예시

하나의 글자를 저장할 때 타입 별 실제 사용되는 저장 공간의 크기를 한 번 살펴보자.

CHAR(1) , VARCHAR(1)

두 문자열 타입 모두 한 글자를 저장할 때 사용하는 문자 집합에 따라 실제 저장 공간을 1 ~ 4 바이트 사용한다.

CHAR 타입에 저장될 때는 추가 공간이 더 필요하지 않다. (고정 길이)

하지만 VARCHAR 타입에 저장될 때는 문자열의 길이를 관리하기 위한 1 ~ 4 바이트의 공간을 추가로 더 사용한다. (가변 길이)

<br>

VARCHAR 타입의 길이가 255바이트 이하이면 1바이트만 사용하고, 256 바이트 이상으로 설정되면 2바이트를 사용한다.

VARCHAR 타입의 최대 길이는 2바이트로 표현할 수 있는 이상은 사용할 수 없다.

즉, VARCHAR 타입의 최대 길이는 65,536 바이트 이상으로 설정할 수 없다.

- WHY?

- 1 바이트 (byte)
    
    - 8개의 비트(bit)로 구성

    - 각 비트는 0 또는 1의 값을 가진다.

    - 8개의 비트로 만들 수 있는 모든 조합을 계산하면 $2^8 = 265$가지이다.

- 2 바이트 (byte)
    
    - 16개의 비트(bit)로 구성

    - 16개의 비트로 만들 수 있는 모든 조합을 계산하면 $2^{16} = 65536$가지이다.
    
<br>

일반적으로 문자열 값이 고정 길이이면 CHAR, 가변 길이이면 VARCHAR 을 선택한다.

> 실제 문자열의 값의 길이가 정적, 가변 으로 타입을 결정하는 것은 적절하지 않다.

<br>

### 문자열 타입을 판단하는 기준

1. 저장되는 문자열의 길이가 대게 비슷한가?

2. 칼럼의 값이 자주 변경 되는가?

<br>

값의 길이도 중요하지만, 해당 칼럼의 값의 성격, 특성에 따라 기준이 돼야한다.

### 예시.

- 1번 기준

    - 주민등록번호 : 모든 전국민이 통일된 주민등록번호를 가지고 있다.

    > 또한 자주 변경되는 부서 번호, 게시물의 상태 값 등은 값이 2~3바이트씩 차이가 나도 CHAR 타입을 사용하는 것이 좋다.

- 2번 기준

    - 이메일 주소 : 이메일 주소의 길이가 일정하지 않다.

    - 주소

<br>

### 주의사항

CHAR, VARCHAR 키워드 뒤에 인자로하는 숫자 값의 의미 ?

칼럼의 바이트 크기가 아니라 문자의 수를 의미한다.

CHAR(10)으로 칼럼을 정의하면 10바이트를 저장할 수 있는 공간 X $\rightarrow$ 10글자(문자)를 저장할 수 있는 공간

<br>

서구권 언어는 각 문자가 1바이트를 사용하므로 10바이트를 사용한다.

아시아권 언어는 각 문자가 최대 2바이트를 사용하므로 20바이트를 사용한다.

<br>

## 15.1.2 저장 공간과 스키마 변경 (Online DDL)

Online DDL : 데이터가 변경되는 도중에도 스키마 변경을 할 수 있는 기능 

DDL(Data Definition Language) : 테이블 생성, 수정, 삭제

<br>

모든 스키마 변경이 온라인으로 가능한 것은 아니다.

### 예시

VARCHAR(60)으로 정의된 칼럼을 가진 테이블에서 확장하는 길이에 따른 ALTER TABLE 명령의 결과

<br>

<p align="center"><img src = images/03.png width=600></p>

<br>

- VARCHAR(60)에서 VARCHAR(63)로 변경

<p align="center"><img src = images/04.png width=600></p>

<br>

> 잠금 없이(LOCK=NONE) 매우 빠르게 변경된 것을 확인할 수 있다.

WHY?

`VARCHAR 타입의 길이가 255바이트 이하이면 1바이트만 사용하고, 256 바이트 이상으로 설정되면 2바이트를 사용한다.`  

utf8mb4는 최대 4바이트를 사용

VARCHAR(60)는 최대 240바이트 (60 * 4) $\rightarrow$ 1바이트

VARCHAR(63)는 최대 252바이트 (63 * 4) $\rightarrow$ 1바이트

메타데이터만 변경하면 되기 때문에 테이블 복사나 잠금이 발생하지 않는다.

<br>

- VARCHAR(60)에서 VARCHAR(64)로 변경

<p align="center"><img src = images/05.png width=600></p>

<br>

<p align="center"><img src = images/06.png width=600></p>

<br>

VARCHAR(63)는 최대 256바이트 (64 * 4) $\rightarrow$ 2바이트

문자열 값의 길이를 저장하는 공간의 크기가 바뀌게 되면 MySQL 서버는 스키마 변경을 하는 동안 읽기 잠금(LOCK=SHARED)을 걸어서 아무도 데이터를 변경하지 못하도록 막고 테이블의 레코드를 복사하는 방식으로 처리한다.

짧게 정리하기

<br>

## 15.1.3 문자 집합(캐릭터 셋)

각 테이블의 칼럼은 모두 서로 다른 문자 집합을 사용해 문자열 값을 저장할 수 있다.

문자 집합은 문자열을 저장하는 `CHAR`, `VARCHAR`, `TEXT` 타입의 칼럼에만 설정할 수 있다.

테이블의 문자 집합을 `UTF-8`로 설정하면 칼럼의 문자 집합을 별도로 지정하지 않아도 UTF-8 문자 집합을 사용한다.

또한 EUC-KR, ASCII 등으로 별도 지정할 수 있다.

MySQL 서버에서 사용 가능한 문자 집합은 `SHOW CHARACTER SET` 명령으로 확인 할 수 있다.

<br>

## 15.1.4 콜레이션(Collation)

콜레이션은 문자열 칼럼의 값에 대한 비교나 정렬 순서를 위한 규칙을 의미한다.

각 문자열 칼럼의 값을 비교하거나 정렬할 때는 항상 문자 집합뿐 아니라 콜레이션의 일치 여부에 따라 결과가 달라지며,  
쿼리의 성능 또한 상당한 영향을 받는다.

MySQL 서버에서 사용 가능한 콜레이션의 목록은 `SHOW COLLATION` 명령을 이용해 확인할 수 있다.

```
문자열의 정렬이나 검색을 위한 비교 작업이 단순히 저장된 문자열 값의 인코딩된 바이트 값(Code point)으로 비교하지 않는다.

인코딩된 상태로 저장된 문자열을 가져와 각 인코딩된 바이트 값에 해당하는 콜레이션 값으로 매칭시킨 다음 비교를 수행한다.

즉, 저장된 문자열의 바이트 값은 직접적인 비교 대상이 아니다.
```

<br>

## 15.1.6 문자열 이스케이프 처리

프로그래밍 언어처럼 `\`를 이용해 이스케이프 처리하는 것이 가능하다.

| 이스케이프 표기 | 의미 |
| --------------- | ---- |
| \0              | 아스키(ASCII) NULL 문자(0x00) |
| \'              | 홑따옴표(') |
| \"              | 쌍따옴표(") |
| \b              | 백스페이스 문자 |
| \n              | 개행문자(라인 피드) |
| \r              | 캐리지 리턴 문자<br>유닉스 계열 운영체제에서는 "\n"만 개행문자로 사용하며, 윈도우 계열 운영체제에서는 "\r\n"의 조합으로 개행문자를 사용한다. |
| \t              | 탭 문자 |
| \ \              | 백 슬래시( \ ) 문자 |
| \%              | 퍼센트(%) 문자(LIKE의 패턴에서만 사용함) |
| \ _              | 언더 스코어(_) 문자(LIKE의 패턴에서만 사용함) |

<br>

# 15.2 숫자

숫자를 저장하는 타입은 값의 정확도에 따라 크게 `참값(Exact value)`과 `근삿값` 타입으로 나눌 수 있다.

```
참값 : 소수점 이하 값의 유무와 관계없이 정확히 그 값을 그대로 유지하는 것을 의미

참값을 관리하는 데이터 타입 : INTEGER, INT, DECIMAL
```

```
근사값 : 부동 소수점이라고 불리는 값을 의미
저장한 값과 조회된 값이 정확하게 일치하지 않고 최대한 비슷한 값을 관리하는 것을 의미

근삿값을 관리하는 타입 : FLOAT, DOUBLE
```

<br>

값이 저장되는 포맷에 따라 `십진 표기법(DECIMAL)`과 `이진 표기법`으로 나눌 수 있다.

```
이진 표기법 : 정수나 실수 타입을 의미, 256까지의 숫자(양수)를 표현할 수 있기에 적은 메모리나 디스크 공간에 저장, INTEGER, BIGINT 등
```

```
십진 표기법 : 각 자릿값을 표현하기 위해 4비트나 한 바이트를 사용해서 표기하는 방법, DECIMAL

DECIMAL 타입 : 금액(돈)처럼 정확하게 소수점까지 관리돼야 하는 값을 저장할 때 사용, 65자리 숫자까지 표현
```

<br>

## 15.2.1 정수

DECIMAL 타입을 제외하고 정수를 저장하는 데 사용할 수 있는 데이터 타입으로는 5가지가 있다.

<p align="center"><img src = images/07.png width=600></p>

<br>

정수 타입은 `UNSIGHNED` 칼럼 옵션을 사용할 수 있다.

옵션을 명시하지 않으면 음수와, 양수를 동시에 저장할 수 있는 숫자 타입(SIGN)

<br>

## 15.2.2 부동 소수점

부동 소수점을 저장하기 위해 `FLOAT` 와 `DOUBLE` 타입을 사용할 수 있다.

```
부동(Floating point) : 소수점 위치가 고정적이지 않다.
```

부동 소수점은 근사값을 저장하는 방식이라 동등 비교(Equal)는 사용할 수 없다.

- FLOAT의 경우

    - 4바이트를 사용해 유효 자릿수 8 (정밀도 명시 X)

    - 최대 8바이트까지 저장 공간을 사용

- DOUBLE의 경우

    - 8바이트의 저장 공간 필요

    - 최대 유효 자릿수 16개 까지 유지 가능

<br>

## 15.2.3 DECIMAL

소수점 위치가 가변적이지 않은 고정 소수점 타입을 위해 `DECIMAL` 타입을 제공

즉, 금액처럼 소수점 이하의 값까지 데이터를 정확하게 관리하려면 DECIMAL 타입을 이용해야 한다.

숫자 하나를 저장하는데 1/2 바이트가 필요하므로 한 자리나 두 자릿수를 저장하는 데 1바이트가 필요하다.

세 자리나 네 자리 숫자를 저장하는 데는 2바이트가 필요하다.

> DECIMAL 로 저장하는 (숫자 자릿수) / 2의 결과값을 올림 처리한 만큼의 바이트 수가 필요하다.

<br>

## 15.3 날짜와 시간

날짜와 시간 따로 저장할 수 있다.

그리고 날짜와 시간을 합쳐서 하나의 칼럼에 저장할 수 있게 여러 가지 타입을 지원한다.

다음 표는 MySQL에서 지원하는 날짜나 시간에 관련된 데이터 타입이다.

<p align="center"><img src = images/08.png width=600></p>

<br>

DATE 와 DATETIME 타입이 많이 사용된다.

<br>

밀리초 단위는 2자리당 1바이트씩 공간이 더 필요하다.

그래서 MySQL 8.0에서는 마이크로초까지 저장 가능한 DATETIME(6) 타입은 8바이트(5 + 3)를 사용한다.

<p align="center"><img src = images/09.png width=600></p>

<br>

# 15.4 ENUM 과 SET

ENUM과 SET은 모두 문자열 값을 MySQL 내부적으로 숫자 값으로 매핑해서 관리하는 타입이다.

<br>

## 15.4.1 ENUM

ENUM 타입은 테이블의 구조(메타 데이터)에 나열된 목록 중 하나의 값을 가질 수 있다.

ENUM 타입의 가장 큰 용도는 코드화된 값을 관리하는 것이다.

ENUM 타입에 사용할 수 있는 최대 아이템의 개수는 65,535개이며, 아이템 개수가 255개 미만이면 ENUM 타입은 저장 공간으로 1바이트를 사용하고, 그 이상인 경우에는 2바이트까지 사용한다.

<br>

ENUM 타입은 테이블 구조에 정의된 코드 값만 사용할 수 있게 강제한다는 장점도 있다.

하지만 더 큰 장점은 DB 서버의 디스크 저장 공간의 크기를 줄여준다는 것이다.

<br>

## 15.4.2 SET

SET 타입도 테이블의 구조에 정의된 아이템을 정숫값으로 매핑해서 저장하는 방식은 똑같다.

SET과 ENUM의 가장 큰 차이는 SET은 하나의 칼럼에 1개 이상의 값을 저장할 수 있다는 점이다.

MySQL 서버는 내부적으로 BIT-OR 연산을 거쳐 1개 이상의 선택된 값을 저장한다.

즉, SET 타입의 칼럼은 여러 개의 값을 저장할 수는 있지만 실제 여러 개의 값을 저장하는 공간을 가지는 것이 아니다.

그래서 각 아이템 값에 매핑되는 정숫값은 1씩 증가하는 정숫값이 아니라 2n의 값을 갖게 된다.

```
아이템 값의 멤버 수가 8개 이하 : 1바이트의 저장 공간

9 ~ 16개 이하 : 2바이트

최대 8바이트까지 저장 공간을 사용한다.
```

<br>

## TEXT와 BLOB

대량의 데이터를 저장하려면 TEXT나 BLOB 타입을 사용해야 한다.

이 두 타입은 거의 똑같은 설정이나 방식으로 작동한다.

- 차이점

    - TEXT 타입 : 문자열을 저장하는 대용량 칼럼이라서 문자 집합이나 콜레이션을 가짐

    - BLOB 타입 : 이진 데이터 타입, 별도의 문자 집합, 콜레이션 X

<br>

다음 표와 같이 TEXT, BLOB 타입 모두 다시 내부적으로 저장 가능한 최대 길이에 따라 4가지 타입으로 구분한다.

<p align="center"><img src = images/10.png width=600></p>

<br>

이진 데이터를 저장하기 위한 데이터 타입과 문자열을 저장하기 위한 데이터 타입은 다음과 같이 고정 길이나 가변 길이 타입이 정확하게 매핑된다.

<p align="center"><img src = images/11.png width=600></p>

<br>

# 15.6 공간 데이터 타입

OpenGIS에서 제시하는 표준을 준수하고 있다.

OpenGIS에서 제공하는 WKT(Well Known Text) 또는 WKB(Well Konown Binary)를 이용해 공간 데이터를 관리할 수 있게 지원한다.

MySQL에서 제공하는 공간 정보 저장용 데이터 타입은 다음 표와 같다.

데이터 타입|정보
|:---:|:---:|
POINT|점
LINESTRING|라인
POLYGON|다각형
GEOMETRY|점,라인,다각형
MULTIPOINT|여러 개의 점
MULTILINESTRING|여러 개의 라인
MULTIPOLYGON|여러 개의 다각형
GEOMETRYCOLLECTION|여러 개의 점, 라인, 다각형

<br>

# 15.7 JSON 타입

MySQL 5.7 버전부터 JSON 데이터를 저장할 수 있는 JSON 타입이 지원되기 시작했다.

## 15.7.1 저장방식

MySQL 서버는 내부적으로 JSON 타입의 값을 BLOB 타입에 저장한다.

저장되는 값을 그대로 저장하는 것이 아니라 바이너리 포맷인 BSON 타입으로 변환해서 저장한다.

그래서 TEXT 타입에 저장하는 것보다 공간 효율이 높기 때문에 BLOB 타입에 저장한다.

<br>

# 15.8 가상 칼럼(파생 칼럼)

가상 칼럼(Virtual Column)과 스토어드 칼럼(Stored Column)으로 구분할 수 있다.

가상 칼럼과 스토어드 칼럼 모두 `다른 칼럼의 값을 참조해서 새로운 값을 만들어 관리`한다.

> 기존 칼럼의 값을 계산해서 관리하는 파생된 칼럼

<br>

### 차이점

- 가상 칼럼(Virtual Column)

    - 칼럼의 값이 디스크에 저장 X

    - 칼럼의 구조 변경은 테이블 리빌드를 필요 X

    - 칼럼의 값은 레코드가 읽히기 전 또는 BEFORE 트리거 실행 직후에 계산되어 만들어짐

- 스토어드 칼럼(Stored Column)

    - 칼럼의 값이 물리적으로 디스크에 저장됨

    - 칼럼의 구조 변경은 다른 일반 테이블과 같이 필요 시 테이블 리빌드 방식으로 처리됨

    - INSERT와 UPDATE 시점에만 칼럼의 값이 계산됨

<br>

### 선택 기준

CPU 사용량을 높여 디스크 부하를 낮출 것인가

디스크 사용량을 높여 CPU 사용량을 낮출 것인가

